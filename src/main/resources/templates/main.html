<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ì–ª–∞–≤–Ω–∞—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-light">

<div class="container py-4">

    <!-- –ú–µ–Ω—é -->
    <div th:replace="~{fragment/user_menu_actions :: userActionsMenu(${authUser})}"></div>

    <!-- –ò–Ω—Ñ–æ –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <h3 class="card-title" th:text="'–ü–µ—Ä—Å–æ–Ω–∞–∂: ' + ${character.name}"></h3>
            <ul class="list-group list-group-flush">
                <li class="list-group-item"><strong>–£–¥–∞–ª—å:</strong> <span th:text="${character.str}"></span></li>
                <li class="list-group-item"><strong>–°–º–µ–∫–∞–ª–∫–∞:</strong> <span th:text="${character.intl}"></span></li>
                <li class="list-group-item"><strong>–û–±–∞—è–Ω–∏–µ:</strong> <span th:text="${character.cha}"></span></li>
            </ul>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏—è -->
    <form method="post" action="/main/search" class="mb-4">
        <button type="submit" class="btn btn-primary w-100">üîç –ù–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏–µ</button>
    </form>

    <!-- –°–æ–±—ã—Ç–∏–µ -->
    <div th:if="${event != null}" class="card mb-4 border-info shadow-sm">
        <div class="card-body">
            <h4 class="text-info" th:text="${event.title}"></h4>
            <p th:text="${event.descr}"></p>
        </div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
    <div th:if="${result != null}" class="card mb-4 border-success shadow-sm">
        <div class="card-body">
            <h4 class="text-success">üé≤ –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–±–æ—Ä–∞</h4>
            <p><strong>–í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:</strong> <span th:text="${result.selectedOption}"></span></p>
            <p><strong>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å:</strong> <span th:text="${result.minDifficulty}"></span></p>
            <p><strong>–í—ã–±—Ä–æ—à–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ:</strong> <span th:text="${result.rolledValue}"></span></p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> <span th:text="${result.resultDescr}"></span></p>

            <div th:if="${result.reward != null}">
                <h6 class="mt-3">üèÖ –ù–∞–≥—Ä–∞–¥—ã:</h6>
                <ul class="list-group list-group-flush">
                    <li th:each="reward : ${result.reward}" class="list-group-item"
                        th:text="${reward.attribute + ': ' + reward.value}"></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π -->
    <div th:if="${options != null}" class="card mb-4 shadow-sm">
        <div class="card-body">
            <label class="form-label">–û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –∞—Ç—Ä–∏–±—É—Ç–∞:</label>
            <input type="number" id="attributeConstraintGlobal" class="form-control mb-3" placeholder="–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è"/>

            <h5>–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:</h5>
            <div class="d-grid gap-2">
                <form th:action="@{/main}" method="post" th:each="opt : ${options}">
                    <input type="hidden" name="attribute" th:value="${opt.attribute}"/>
                    <input type="hidden" name="descr" th:value="${opt.descr}"/>
                    <input type="hidden" name="remainingAttempts" th:value="${opt.remainingAttempts}">
                    <button type="submit" class="btn btn-outline-secondary"
                            th:text="${opt.descr + ' (' + opt.attribute + ') x ' + opt.remainingAttempts}">
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- –û—à–∏–±–∫–∞ -->
    <div th:if="${param.name != null and event == null}" class="alert alert-danger">
        –°–æ–±—ã—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
    </div>

</div>

<!-- Toast –æ—à–∏–±–∫–∏ -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0"
         role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="10000"
         th:if="${handledError}">
        <div class="d-flex">
            <div class="toast-body" th:text="${handledError}"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const toastEl = document.getElementById('errorToast');
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    });

    document.querySelectorAll("form").forEach(form => {
        form.addEventListener("submit", function (e) {
            const globalVal = document.getElementById("attributeConstraintGlobal")?.value;
            if (globalVal !== "") {
                let hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = "attributeConstraint";
                hidden.value = globalVal;
                form.appendChild(hidden);
            }
        });
    });
</script>

</body>
</html>