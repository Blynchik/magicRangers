<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Создание события</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<h1>Создание события</h1>

<form th:action="@{/event}" th:object="${event}" method="post">

    <div>
        <label for="title">Название:</label>
        <input type="text" id="title" th:field="*{title}"/>
        <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" style="color:red;"></div>
    </div>

    <div>
        <label for="descr">Описание:</label>
        <textarea id="descr" th:field="*{descr}" maxlength="1000" rows="5" class="form-control"></textarea>
        <div th:if="${#fields.hasErrors('descr')}" th:errors="*{descr}" style="color:red;"></div>
    </div>

    <div>
        <h3>Опции и результаты</h3>
        <div id="optionResultPairs-container">
            <!-- JS будет добавлять сюда блоки пар -->
        </div>
        <button type="button" class="btn btn-outline-primary mb-3" onclick="addOptionResultPair()">Добавить вариант
        </button>
        <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="removePair(this)">Удалить вариант
        </button>
    </div>

    <div>
        <button type="submit">Создать</button>
    </div>
    <div th:if="${#fields.hasGlobalErrors()}" style="color:red;">
        <ul>
            <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
        </ul>
    </div>
</form>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0"
         role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="10000"
         th:if="${handledError}">
        <div class="d-flex">
            <div class="toast-body" th:text="${handledError}"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        const toastEl = document.getElementById('errorToast');
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    });
</script>

<template id="optionResultTemplate">
    <div class="option-result-block mb-3">
        <fieldset class="border p-3 rounded">
            <legend class="float-none w-auto px-2">Вариант #[#]</legend>

            <label>Атрибут:</label>
            <select name="optionRequests[#].attribute" class="form-select mb-2">
                <option value="">-- выберите --</option>
                <option value="STR">Удаль</option>
                <option value="INTL">Смекалка</option>
                <option value="CHA">Обаяние</option>
            </select>

            <label>Описание опции:</label>
            <input type="text" name="optionRequests[#].descr" class="form-control mb-2"/>

            <div class="results-container"></div>

            <button type="button" class="btn btn-sm btn-outline-primary mb-2" onclick="addResult(this, #)">Добавить
                результат
            </button>
            </button>
        </fieldset>
    </div>
</template>

<!-- Новый шаблон для одного результата -->
<template id="resultTemplate">
    <div class="result-block border rounded p-2 mb-2">
        <label>Сложность:</label>
        <input type="number" name="optionRequests[#].results[##].minDifficulty" class="form-control mb-2"/>

        <label>Описание результата:</label>
        <textarea name="optionRequests[#].results[##].descr" rows="2" class="form-control mb-2"></textarea>

        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeResult(this)">Удалить результат
        </button>
    </div>
</template>

<script>
    let pairCount = 0;

    function replaceIndex(templateHTML, index) {
    return templateHTML
        .replace(/\[#\]/g, `[${index}]`)
        .replace(/onclick="addResult\(this, #\)"/g, `onclick="addResult(this, ${index})"`);
}

    function addOptionResultPair() {
        const container = document.getElementById('optionResultPairs-container');
        const template = document.getElementById('optionResultTemplate');
        let html = replaceIndex(template.innerHTML, pairCount);
        container.insertAdjacentHTML('beforeend', html);
        pairCount++;
    }

    function removePair(button) {
        const block = button.closest('.option-result-block');
        block.remove();
    }

    window.addEventListener('DOMContentLoaded', () => {
        addOptionResultPair(); // одна пара по умолчанию
    });

    let optionIndex = 0;

function addResult(button, optionIdx) {
    const resultsContainer = button.parentElement.querySelector('.results-container');
    const resultTemplate = document.getElementById('resultTemplate').innerHTML;

    const currentResults = resultsContainer.querySelectorAll('.result-block').length;
    const html = resultTemplate
        .replaceAll('[#]', `[${optionIdx}]`)
        .replaceAll('[##]', `[${currentResults}]`);

    const resultDiv = document.createElement('div');
    resultDiv.innerHTML = html;
    resultsContainer.appendChild(resultDiv);
}

function removePair(button) {
    button.closest('.option-result-block').remove();
}

function removeResult(button) {
    button.closest('.result-block').remove();
}
</script>

</body>
</html>