<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body class="bg-light">

<!-- –ú–µ–Ω—é -->
<div th:replace="~{fragment/user_menu_actions :: userActionsMenu(${authUser})}"></div>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <h1 class="text-center mb-4">‚ú® –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h1>

            <form th:action="@{/event}" th:object="${event}" method="post" class="card shadow-sm p-4">

                <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
                <div class="mb-3">
                    <label for="title" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</label>
                    <input type="text" id="title" th:field="*{title}" class="form-control"/>
                    <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="text-danger small"></div>
                </div>

                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="mb-3">
                    <label for="descr" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="descr" th:field="*{descr}" maxlength="1000" rows="5"
                              class="form-control"></textarea>
                    <div th:if="${#fields.hasErrors('descr')}" th:errors="*{descr}" class="text-danger small"></div>
                </div>

                <!-- –û–ø—Ü–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                <div class="mb-3">
                    <h4 class="mb-3">–û–ø—Ü–∏–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</h4>
                    <div id="optionResultPairs-container"></div>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="addOptionResultPair()">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç
                    </button>
                </div>

                <!-- –û—à–∏–±–∫–∏ -->
                <div th:if="${#fields.hasErrors()}" class="alert alert-danger mt-3">
                    <h6 class="alert-heading">‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:</h6>
                    <ul class="mb-0">
                        <li th:each="err : ${#fields.errors()}" th:text="${err}"></li>
                    </ul>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="submit" class="btn btn-success">
                        ‚úÖ –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
                    </button>
                </div>

                <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ -->
                <div th:if="${#fields.hasGlobalErrors()}" class="alert alert-danger mt-3">
                    <ul>
                        <li th:each="err : ${#fields.globalErrors()}" th:text="${err}"></li>
                    </ul>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0"
         role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-delay="10000"
         th:if="${handledError}">
        <div class="d-flex">
            <div class="toast-body" th:text="${handledError}"></div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto"
                    data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        const toastEl = document.getElementById('errorToast');
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    });
</script>

<!-- –®–∞–±–ª–æ–Ω—ã –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–≤–∞—Ä–∏–∞–Ω—Ç—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –Ω–∞–≥—Ä–∞–¥—ã) -->
<template id="optionResultTemplate">
    <div class="option-result-block mb-3">
        <div class="card border-primary shadow-sm">
            <div class="card-body">
                <h5 class="card-title">–í–∞—Ä–∏–∞–Ω—Ç #[#]</h5>
                <button type="button" class="btn btn-sm btn-outline-danger mb-3" onclick="removePair(this)">üóë –£–¥–∞–ª–∏—Ç—å
                    –≤–∞—Ä–∏–∞–Ω—Ç
                </button>

                <label class="form-label">–ê—Ç—Ä–∏–±—É—Ç:</label>
                <select name="optionRequests[#].attribute" class="form-select mb-2">
                    <option value="">-- –≤—ã–±–µ—Ä–∏—Ç–µ --</option>
                    <option value="STR">üõ° –£–¥–∞–ª—å</option>
                    <option value="INTL">üß† –°–º–µ–∫–∞–ª–∫–∞</option>
                    <option value="CHA">üíã –û–±–∞—è–Ω–∏–µ</option>
                    <option value="TEXT">üìú –¢–µ–∫—Å—Ç –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏</option>
                    <option value="DECLINE">üö´ –û—Ç–∫–∞–∑</option>
                </select>

                <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø—Ü–∏–∏:</label>
                <input type="text" name="optionRequests[#].descr" class="form-control mb-2"/>

                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫:</label>
                <input type="number" name="optionRequests[#].remainingAttempts" class="form-control mb-3"/>

                <div class="results-container mb-2"></div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addResult(this, #)">‚ûï –î–æ–±–∞–≤–∏—Ç—å
                    —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                </button>
            </div>
        </div>
    </div>
</template>

<template id="resultTemplate">
    <div class="result-block border rounded p-2 mb-3">
        <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</label>
        <input type="number" name="optionRequests[#].results[##].minDifficulty" class="form-control mb-2"/>

        <div class="probable-results-container mb-2">
        </div>

        <button type="button" class="btn btn-sm btn-outline-primary mb-2"
                onclick="addProbableResult(this, #, ##)">–î–æ–±–∞–≤–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        </button>

        <button type="button" class="btn btn-sm btn-outline-danger"
                onclick="removeResult(this)">–£–¥–∞–ª–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        </button>
    </div>
</template>

<template id="probableResultTemplate">
    <div class="probable-result-block border p-2 mb-2">
        <label>–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å (%):</label>
        <input type="number" step="0.000001"
               name="optionRequests[#].results[##].probableResults[###].probabilityPercent"
               class="form-control mb-2"/>
        <label>–û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:</label>
        <textarea name="optionRequests[#].results[##].probableResults[###].descr" rows="2"
                  class="form-control mb-2"></textarea>
        <div class="form-check mb-2">
            <input type="checkbox"
                   class="form-check-input"
                   name="optionRequests[#].results[##].probableResults[###].isFinal"
                   value="true"
                   id="finalResultCheckbox###">
            <label class="form-check-label" for="finalResultCheckbox###">
                –§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            </label>
        </div>

        <div class="rewards-container mb-2">
            <h5>–ù–∞–≥—Ä–∞–¥—ã:</h5>
        </div>
        <button type="button" class="btn btn-sm btn-outline-secondary mb-2"
                onclick="addReward(this, #, ##, ###)">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
        </button>

        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeProbableResult(this)">
            –£–¥–∞–ª–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        </button>
    </div>
</template>

<template id="rewardTemplate">
    <div class="reward-block border p-2 mb-2">
        <label>–¢–∏–ø –Ω–∞–≥—Ä–∞–¥—ã:</label>
        <select name="optionRequests[#].results[##].probableResults[###].rewardList[####].type"
                class="form-select mb-2">
            <option value="STR">–£–¥–∞–ª—å</option>
            <option value="INTL">–°–º–µ–∫–∞–ª–∫–∞</option>
            <option value="CHA">–û–±–∞—è–Ω–∏–µ</option>
        </select>

        <label>–ó–Ω–∞—á–µ–Ω–∏–µ:</label>
        <input type="number"
               name="optionRequests[#].results[##].probableResults[###].rewardList[####].value"
               class="form-control mb-2"/>

        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeReward(this)">
            –£–¥–∞–ª–∏—Ç—å –Ω–∞–≥—Ä–∞–¥—É
        </button>
    </div>
</template>
<script>
    let pairCount = 0;

    function replaceIndex(templateHTML, index) {
    return templateHTML
        .replace(/\[#\]/g, `[${index}]`)
        .replace(/onclick="addResult\(this, #\)"/g, `onclick="addResult(this, ${index})"`);
}

    function addOptionResultPair() {
        const container = document.getElementById('optionResultPairs-container');
        const template = document.getElementById('optionResultTemplate');
        let html = replaceIndex(template.innerHTML, pairCount);
        container.insertAdjacentHTML('beforeend', html);
        pairCount++;
    }

    window.addEventListener('DOMContentLoaded', () => {
        addOptionResultPair(); // –æ–¥–Ω–∞ –ø–∞—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    });

    let optionIndex = 0;

function addResult(button, optionIdx) {
    const resultsContainer = button.parentElement.querySelector('.results-container');
    const resultTemplate = document.getElementById('resultTemplate').innerHTML;

    const resultIndex = resultsContainer.querySelectorAll('.result-block').length;

    const html = resultTemplate
        .replaceAll('[#]', `[${optionIdx}]`)
        .replaceAll('[##]', `[${resultIndex}]`)
        .replace(/onclick="addProbableResult\(this, #, ##\)"/g, `onclick="addProbableResult(this, ${optionIdx}, ${resultIndex})"`);

    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    resultsContainer.appendChild(wrapper);

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω –≤–µ—Ä–æ—è—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const addProbBtn = wrapper.querySelector('button[onclick^="addProbableResult"]');
    addProbableResult(addProbBtn, optionIdx, resultIndex);
    }

function removePair(button) {
    button.closest('.option-result-block').remove();
}

function removeResult(button) {
    button.closest('.result-block').remove();
}
</script>

<script>
    function addProbableResult(button, optionIdx, resultIdx) {
    const container = button.parentElement.querySelector('.probable-results-container');
    const template = document.getElementById('probableResultTemplate').innerHTML;
    const currentCount = container.querySelectorAll('.probable-result-block').length;

    let html = template
        .replaceAll('[#]', `[${optionIdx}]`)
        .replaceAll('[##]', `[${resultIdx}]`)
        .replaceAll('[###]', `[${currentCount}]`)
        .replace(/onclick="addReward\(this, #, ##, ###\)"/g,
                `onclick="addReward(this, ${optionIdx}, ${resultIdx}, ${currentCount})"`);

    const div = document.createElement('div');
    div.innerHTML = html;
    container.appendChild(div);


    const addRewardBtn = div.querySelector('button[onclick^="addReward"]');
    if (addRewardBtn) {
        addRewardBtn.click(); // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–π –Ω–∞–≥—Ä–∞–¥—ã
    }
}

function removeProbableResult(button) {
    button.closest('.probable-result-block').remove();
}

    function addReward(button, optionIdx, resultIdx, probableResultIdx) {
    const container = button.parentElement.querySelector('.rewards-container');
    const template = document.getElementById('rewardTemplate').innerHTML;
    const currentCount = container.querySelectorAll('.reward-block').length;

    const html = template
        .replaceAll('[#]', `[${optionIdx}]`)
        .replaceAll('[##]', `[${resultIdx}]`)
        .replaceAll('[###]', `[${probableResultIdx}]`)
        .replaceAll('[####]', `[${currentCount}]`);

    const div = document.createElement('div');
    div.innerHTML = html;
    container.appendChild(div);
}

function removeReward(button) {
    button.closest('.reward-block').remove();
}
</script>
</body>
</html>